import { getProducts, Product } from '@stripe/firestore-stripe-payments';
import Head from 'next/head';
import { useRecoilValue } from 'recoil';
import { modalState, movieState } from '../atoms/modalAtom';
import Banner from '../components/Banner';
import Header from '../components/Header';
import Modal from '../components/Modal';
import Plans from '../components/Plans';
import Row from '../components/Row';
import useAuth from '../hooks/useAuth';
import useList from '../hooks/useList';
import useSubscription from '../hooks/useSubscription';
import payments from '../lib/stripe';
import { Movie } from '../typing';
import requests from '../utils/requests';

type Props = {
	trendingNow: Movie[],
	products: Product[]
};

export const getServerSideProps = async () => {

	try {
		//const [trendingNow] = await Promise.all([fetch(requests.fetchTrending).then((results) => results.json())]);
		const trendingNow = await fetch(requests.fetchTrending);
		const renderTrending = await trendingNow.json();
		
		const products = await getProducts(payments, {
			includePrices: true,
			activeOnly: true,
		});
		
		return {
			props: {
				//trendingNow: trendingNow.results,
				trendingNow: renderTrending.results,
				products
			},
		};

	} catch (error) {
		console.trace(error);
	}
};

const Home = ({ trendingNow, products }: Props) => {

	const { loading, user } = useAuth();
	const showModal = useRecoilValue(modalState);
	const subscription = useSubscription(user);
	const movie = useRecoilValue(movieState);
	const list = useList(user?.uid);

	if (loading || subscription === null) {
		return null;
	}
	
	if (!subscription) {
		return <Plans products={products}/>;
	}

	return (
		<div className='relative h-screen bg-gradient-to-b from-gray-900/10 to-[#010511] lg:h-[140vh]'>
			<Head>
				<title>Tonyflix - Accueil</title>
				<meta name='description' content='Generated by create next app' />
				<link rel='icon' href='/favicon.ico' />
			</Head>
			<Header />
			<main className='relative pl-4 pb-24 lg:space-y-24 lg:pl-16'>
				<Banner bannerData={trendingNow} />
				<section className='md:space-y-24'>
					<Row title='Tendances actuelles' movies={trendingNow}/>
					{list.length > 0 && <Row title="Ma Liste" movies={list} />}
				</section>
			</main>
			{showModal && <Modal />}
		</div>
	);
};

export default Home;
